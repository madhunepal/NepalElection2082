---
import { createClient } from '@supabase/supabase-js';
import '../styles/global.css';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  throw new Error('Missing PUBLIC_SUPABASE_URL or PUBLIC_SUPABASE_ANON_KEY in .env');
}

const supabase = createClient(supabaseUrl, supabaseKey);

const partyColorMap: Record<string, string> = {
  "नेपाली काँग्रेस": "bg-green-100 text-green-800 border-green-200",
  "नेपाल कम्युनिष्ट पार्टी (एकीकृत मार्क्सवादी लेनिनवादी)": "bg-red-100 text-red-800 border-red-200",
  "नेकपा एमाले": "bg-red-100 text-red-800 border-red-200", // Handle abbreviation
  "नेपाल कम्युनिष्ट पार्टी (माओवादी केन्द्र)": "bg-rose-100 text-rose-800 border-rose-200",
  "राष्ट्रिय स्वतन्त्र पार्टी": "bg-blue-100 text-blue-800 border-blue-200",
  "राष्ट्रिय प्रजातन्त्र पार्टी": "bg-purple-100 text-purple-800 border-purple-200",
  "जनता समाजवादी पार्टी, नेपाल": "bg-green-100 text-green-800 border-green-200",
  "स्वतन्त्र": "bg-gray-100 text-gray-800 border-gray-200",
};

// URL params
const url = new URL(Astro.request.url);
const selectedProvince = url.searchParams.get('province') || 'all';
const selectedParty = url.searchParams.get('party') || 'all';
const selectedGender = url.searchParams.get('gender') || 'all';
const searchQuery = url.searchParams.get('search') || '';
const currentPage = Math.max(1, Number(url.searchParams.get('page') || '1'));
const pageSize = 20;

// Query with pagination + filter
let query = supabase
  .from('candidates')
  .select('candidate_id, name, age, gender, party, province, district', { count: 'exact' })
  .range((currentPage - 1) * pageSize, currentPage * pageSize - 1)
  .order('name');

if (searchQuery) {
  query = query.ilike('name', `%${searchQuery}%`);
}

if (selectedGender !== 'all') {
  query = query.eq('gender', selectedGender);
}

if (selectedProvince !== 'all') {
  query = query.eq('province', selectedProvince);
}

if (selectedParty !== 'all') {
  query = query.eq('party', selectedParty);
}

const { data: candidates = [], error, count: totalCount = 0 } = await query;

// Unique provinces
const { data: provincesData } = await supabase
  .from('candidates')
  .select('province')
  .not('province', 'is', null)
  .limit(10000);

const uniqueProvinces = [...new Set(provincesData?.map(p => p.province) || [])].sort();

// Unique parties
const { data: partiesData } = await supabase
  .from('candidates')
  .select('party')
  .not('party', 'is', null)
  .limit(10000);

const uniqueParties = [...new Set(partiesData?.map(p => p.party) || [])].sort();

// We need overall totals for the Statistics Cards. Let's fetch the counts using a very light query.
let totalCandidatesCount = totalCount;
let totalUniquePartiesCount = 66; // Hardcoded per user request
let totalUniqueProvincesCount = 7; // Hardcoded per user request
// Hardcoded 77 Districts for Nepal as it is a constant, or we could fetch it if there was a district column
let totalDistrictsCount = 77;

if (selectedProvince !== 'all' || selectedParty !== 'all' || selectedGender !== 'all' || searchQuery) {
  // If we have filters active, the 'totalCount', 'uniqueParties', etc represent the *filtered* view.
  // The global statistics board at the top of chunab2082 usually shows global absolute numbers.
  // We'll fetch just a quick count for the overall absolute numbers for the stat cards:
  const { count: globalCount } = await supabase.from('candidates').select('*', { count: 'exact', head: true });
  totalCandidatesCount = globalCount || 0;
  
  // (Optional optimization: We are caching 'totalUniquePartiesCount' globally from the db anyways, 
  // since the not(null) queries above aren't affected by the currently applied query filters 
  // unless we apply them, which we didn't). 
}

// Prepare Data for Charts (Party Distribution & Qualification)
// We will aggregate this from the database for the *entire* dataset regardless of filters, 
// matching how the original dashboard analysis section behaves.
const { data: allCandidatesForCharts } = await supabase
  .from('candidates')
  .select('party, qualification')
  .limit(10000); // Fetch all to aggregate

const partyCounts: Record<string, number> = {};
const qualificationCounts: Record<string, number> = {};

if (allCandidatesForCharts) {
  allCandidatesForCharts.forEach(c => {
    if (c.party) {
      partyCounts[c.party] = (partyCounts[c.party] || 0) + 1;
    }
    // Handle specific mappings for Qualifications based on original data (sometimes numeric or unstructured)
    // Using simple mapping based on source code grouping
    let qual = c.qualification || 'Other';
    // Clean up obvious synonyms based on screenshots
    if (qual.includes('Class 10') || qual.includes('S.L.C.') || qual.includes('SEE')) qual = 'SLC / SEE';
    if (qual.includes('10+2') || qual.includes('Certificate') || qual.includes('Intermediate')) qual = '+2 / Diploma';
    if (qual.includes('Bachelor')) qual = 'Bachelors';
    if (qual.includes('Master')) qual = 'Masters';
    if (qual.includes('Ph.D') || qual.includes('M.Phil')) qual = 'Ph.D / M.Phil';
    if (qual.includes('Literate')) qual = 'Literate';
    if (qual.includes('Under S.L.C.')) qual = 'Below SLC';
    
    qualificationCounts[qual] = (qualificationCounts[qual] || 0) + 1;
  });
}

// Convert objects to arrays for Chart.js sorting
const partyChartData = Object.entries(partyCounts)
  .map(([name, value]) => ({ name, value }))
  .sort((a, b) => b.value - a.value)
  .slice(0, 10); // Show top 10

const qualChartData = Object.entries(qualificationCounts)
  .map(([name, value]) => ({ name, value }))
  .sort((a, b) => b.value - a.value);

// Pagination math
const totalPages = Math.ceil(totalCount / pageSize);
const hasPrev = currentPage > 1;
const hasNext = currentPage < totalPages;
---

<html lang="ne">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>नेपाल निर्वाचन उम्मेदवार ड्यासबोर्ड | Nepal Election Dashboard</title>
    <!-- Chart.js Injection -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="bg-background min-h-screen font-sans antialiased text-foreground">
    
    <!-- Navigation Header -->
    <header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div class="container mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex gap-6 md:gap-10">
          <a href="/" class="flex items-center space-x-2">
            <div class="bg-primary text-primary-foreground font-bold rounded-lg p-1.5 h-8 w-8 flex items-center justify-center shadow-sm">
              ED
            </div>
            <div>
              <span class="inline-block font-bold">निर्वाचन डाटा</span>
              <span class="block text-[10px] text-muted-foreground -mt-1">Election Data Nepal</span>
            </div>
          </a>
        </div>
        
        <nav class="flex items-center gap-2">
           <a href="#" class="flex items-center text-muted-foreground hover:text-foreground hover:bg-muted rounded-full px-4 py-2 text-sm font-medium transition-colors gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
              ड्यासबोर्ड <span class="hidden md:inline">(Dashboard)</span>
           </a>
           <div class="flex items-center bg-primary text-primary-foreground rounded-full px-4 py-2 text-sm font-medium shadow-sm gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              उम्मेदवारहरू <span class="hidden md:inline">(Candidates)</span>
           </div>
           <a href="#" class="flex items-center text-muted-foreground hover:text-foreground hover:bg-muted rounded-full px-4 py-2 text-sm font-medium transition-colors gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
              विश्लेषण <span class="hidden md:inline">(Analysis)</span>
           </a>
           <a href="#" class="flex items-center text-muted-foreground hover:text-foreground hover:bg-muted rounded-full px-4 py-2 text-sm font-medium transition-colors gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              नतिजा <span class="hidden md:inline">(Result)</span>
           </a>
        </nav>
      </div>
    </header>

    <main class="container mx-auto px-4 py-8">
      
      <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight mb-2 nepali-text text-foreground">
          नेपाल निर्वाचन उम्मेदवार
        </h1>
        <p class="text-muted-foreground">
          Nepal Election Candidates Dashboard<br/>
          <span class="text-sm">जिल्ला, प्रदेश, र पार्टी अनुसार उम्मेदवारहरू खोज्नुहोस् • Explore candidates by district, province, and party</span>
        </p>
      </div>

      <!-- Global Statistics Cards (4 Columns) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="stat-card flex justify-between items-start">
          <div>
            <p class="text-sm text-foreground/80 font-semibold nepali-text">कुल उम्मेदवार</p>
            <p class="text-xs text-muted-foreground mb-2">Total Candidates</p>
            <p class="text-4xl font-bold text-foreground">{totalCandidatesCount.toLocaleString()}</p>
          </div>
          <div class="bg-secondary p-3 rounded-xl text-muted-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
        </div>

        <div class="stat-card flex justify-between items-start">
          <div>
            <p class="text-sm text-foreground/80 font-semibold nepali-text">राजनीतिक दलहरू</p>
            <p class="text-xs text-muted-foreground mb-2">Political Parties</p>
            <p class="text-4xl font-bold text-foreground">{totalUniquePartiesCount}</p>
          </div>
          <div class="bg-secondary p-3 rounded-xl text-muted-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>
          </div>
        </div>

        <div class="stat-card flex justify-between items-start">
          <div>
             <p class="text-sm text-foreground/80 font-semibold nepali-text">जिल्लाहरू</p>
             <p class="text-xs text-muted-foreground mb-2">Districts</p>
             <p class="text-4xl font-bold text-foreground">{totalDistrictsCount}</p>
          </div>
          <div class="bg-secondary p-3 rounded-xl text-muted-foreground">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
          </div>
        </div>

        <div class="stat-card flex justify-between items-start">
          <div>
             <p class="text-sm text-foreground/80 font-semibold nepali-text">प्रदेशहरू</p>
             <p class="text-xs text-muted-foreground mb-2">Provinces</p>
             <p class="text-4xl font-bold text-foreground">{totalUniqueProvincesCount}</p>
          </div>
          <div class="bg-secondary p-3 rounded-xl text-muted-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="bg-card border border-border rounded-xl p-5 shadow-sm mb-12">
        <h3 class="text-sm font-semibold text-foreground/80 mb-3 nepali-text">फिल्टर <span class="text-muted-foreground font-normal">(Filters)</span></h3>
        
        <div class="flex flex-col md:flex-row gap-3">
          <!-- Name Search -->
          <div class="flex-1">
             <input 
               type="text" 
               id="searchInput" 
               class="w-full px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-1 focus:ring-ring bg-background text-sm" 
               placeholder="नाम खोज्नुहोस् (Search Name)..."
               value={searchQuery}
               onkeypress="if(event.key === 'Enter') updateFilters()"
             />
          </div>

          <!-- Province Filter -->
          <select
            id="provinceSelect"
            class="px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-1 focus:ring-ring bg-background text-sm flex-1"
            onchange="updateFilters()"
          >
            <option value="all">प्रदेश (Province)</option>
            {uniqueProvinces.map(prov => (
              <option value={prov} selected={selectedProvince === prov}>
                {prov}
              </option>
            ))}
          </select>

          <!-- Party Filter -->
          <select
            id="partySelect"
            class="px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-1 focus:ring-ring bg-background text-sm flex-1 md:max-w-xs"
            onchange="updateFilters()"
          >
            <option value="all">पार्टी (Party)</option>
            {uniqueParties.map(party => (
              <option value={party} selected={selectedParty === party}>
                {party}
              </option>
            ))}
          </select>

          <!-- Gender Filter -->
          <select
            id="genderSelect"
            class="px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-1 focus:ring-ring bg-background text-sm flex-1"
            onchange="updateFilters()"
          >
            <option value="all">सबै लिङ्ग (All Genders)</option>
            <option value="पुरुष" selected={selectedGender === 'पुरुष'}>पुरुष (Male)</option>
            <option value="महिला" selected={selectedGender === 'महिला'}>महिला (Female)</option>
            <option value="अन्य" selected={selectedGender === 'अन्य'}>अन्य (Other)</option>
          </select>

          <button onclick="updateFilters()" class="px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground text-sm font-medium rounded-md shadow transition-colors w-full md:w-auto mt-2 md:mt-0 whitespace-nowrap">
            खोज्नुहोस् / Apply
          </button>
        </div>
      </div>

      {error ? (
        <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg mb-8 text-red-700">
          <p class="font-medium">डाटा लोड गर्न समस्या / Error loading data:</p>
          <p class="mt-2">{error.message}</p>
        </div>
      ) : (
        <div>
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold tracking-tight text-foreground nepali-text">उम्मेदवारहरू <span class="text-sm font-normal text-muted-foreground ml-2">(Candidates)</span></h2>
            <p class="text-muted-foreground text-sm">
              Showing {candidates.length} of {totalCount} • Page {currentPage}/{totalPages || 1}
            </p>
          </div>

          {candidates.length === 0 ? (
            <div class="text-center py-16 bg-card border border-border rounded-xl text-muted-foreground text-lg shadow-sm mb-10">
               <svg class="mx-auto h-12 w-12 text-muted-foreground/50 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
               </svg>
              कुनै उम्मेदवार फेला परेन / No candidates found
            </div>
          ) : (
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10">
              {candidates.map((c) => {
                const partyColor = partyColorMap[c.party] || "bg-secondary text-secondary-foreground border-border";
                return (
                <div class="candidate-card h-full flex flex-col justify-between">
                  <div>
                    <div class="flex items-start gap-3">
                      <!-- Avatar placeholder -->
                      <div class="flex h-12 w-12 items-center justify-center rounded-full bg-secondary overflow-hidden shrink-0">
                        {/* If no image exists from election.gov.np, fallback to initial gracefully. */}
                        <div class="flex items-center justify-center text-muted-foreground font-bold text-lg w-full h-full">
                          {c.name.charAt(0)}
                        </div>
                      </div>

                      <div class="flex-1 min-w-0">
                        <!-- Name -->
                        <h3 class="text-name text-foreground truncate nepali-text">
                          {c.name}
                        </h3>

                        <!-- Party Badge -->
                        <div class="mt-1.5 flex flex-wrap items-center gap-2">
                          <span class={`badge-party border ${partyColor} nepali-text`}>
                            {c.party === 'नेपाल कम्युनिष्ट पार्टी (एकीकृत मार्क्सवादी लेनिनवादी)' ? 'नेकपा एमाले' : c.party}
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Details Grid -->
                    <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
                      <div class="flex items-center gap-1.5 text-muted-foreground mr-2 col-span-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3.5 w-3.5 shrink-0"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        <span class="truncate">{c.district ? `${c.district} - क्षेत्र १` : c.province}</span>
                      </div>
                      <div class="flex items-center gap-1.5 text-muted-foreground col-span-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3.5 w-3.5 shrink-0"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                        <span>{c.age} वर्ष</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mt-4 pt-3 border-t border-border flex justify-end">
                    <span class="text-xs text-muted-foreground border border-border px-2 py-1 rounded">{c.gender}</span>
                  </div>
                </div>
              )})}
            </div>
          )}

          <!-- Pagination -->
          <div class="flex justify-center items-center gap-4 py-8">
            <button
              onclick={`window.location.href = '?province=${encodeURIComponent(selectedProvince)}&party=${encodeURIComponent(selectedParty)}&gender=${encodeURIComponent(selectedGender)}&search=${encodeURIComponent(searchQuery)}&page=${currentPage - 1}'`}
              disabled={!hasPrev}
              class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 rounded-md px-3"
            >
              &larr; Previous 
            </button>

            <span class="text-sm font-medium text-foreground bg-secondary px-4 py-1.5 rounded-md">
              {currentPage} / {totalPages || 1}
            </span>

            <button
              onclick={`window.location.href = '?province=${encodeURIComponent(selectedProvince)}&party=${encodeURIComponent(selectedParty)}&gender=${encodeURIComponent(selectedGender)}&search=${encodeURIComponent(searchQuery)}&page=${currentPage + 1}'`}
              disabled={!hasNext}
              class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 rounded-md px-3"
            >
              Next &rarr;
            </button>
          </div>
        </div>
      )}

      <!-- Analysis Charts Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        <!-- Party Chart -->
        <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
          <div class="mb-6">
            <h3 class="font-semibold text-foreground text-lg nepali-text">पार्टी अनुसार उम्मेदवार</h3>
            <p class="text-xs text-muted-foreground">Candidates by Party</p>
          </div>
          <div class="h-80 w-full relative">
            <canvas id="partyChart"></canvas>
          </div>
        </div>

        <!-- Qualification Chart -->
        <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
          <div class="mb-6">
            <h3 class="font-semibold text-foreground text-lg nepali-text">शैक्षिक योग्यता</h3>
            <p class="text-xs text-muted-foreground">Qualification Distribution</p>
          </div>
          <div class="h-80 w-full relative -ml-4 flex justify-center items-center">
             <canvas id="qualificationChart"></canvas>
          </div>
        </div>
      </div>
    </main>
    <script is:inline define:vars={{ partyChartData, qualChartData }}>
      function updateFilters() {
        const province = document.getElementById('provinceSelect').value;
        const party = document.getElementById('partySelect').value;
        const gender = document.getElementById('genderSelect').value;
        const search = document.getElementById('searchInput').value;
        
        const url = new URL(window.location.href);
        const searchParams = url.searchParams;

        // Reset page to 1 when filters change
        searchParams.delete('page');

        if (province !== 'all') searchParams.set('province', province);
        else searchParams.delete('province');

        if (party !== 'all') searchParams.set('party', party);
        else searchParams.delete('party');
        
        if (gender !== 'all') searchParams.set('gender', gender);
        else searchParams.delete('gender');
        
        if (search) searchParams.set('search', search);
        else searchParams.delete('search');

        window.location.href = url.toString();
      }

      // -----------------------------
      // Chart.js Configuration
      // -----------------------------
      document.addEventListener("DOMContentLoaded", function() {
        const CHART_COLORS = [
          "hsl(215, 55%, 35%)", // Deep blue
          "hsl(350, 55%, 50%)", // Crimson
          "hsl(160, 50%, 45%)", // Green
          "hsl(35, 70%, 55%)",  // Orange/Yellow
          "hsl(270, 40%, 55%)", // Purple
          "hsl(190, 55%, 45%)", // Cyan
          "hsl(25, 65%, 50%)",  // Orange
          "hsl(200, 15%, 50%)", // Gray blue
        ];

        // 1. Party Bar Chart (Horizontal)
        const ctxParty = document.getElementById('partyChart');
        if (ctxParty && partyChartData.length > 0) {
          
          // Helper to abbreviate long party names exactly like their getShortPartyName()
          const getShortName = (name) => {
            const map = {
              "नेपाल कम्युनिष्ट पार्टी (एकीकृत मार्क्सवादी लेनिनवादी)": "नेकपा एमाले",
              "नेपाली काँग्रेस": "काँग्रेस",
              "नेपाल कम्युनिष्ट पार्टी (माओवादी केन्द्र)": "माओवादी केन्द्र",
              "राष्ट्रिय स्वतन्त्र पार्टी": "रास्वपा",
              "राष्ट्रिय प्रजातन्त्र पार्टी": "राप्रपा",
              "जनता समाजवादी पार्टी, नेपाल": "जसपा"
            };
            return map[name] || (name.length > 20 ? name.substring(0, 20) + '...' : name);
          };

          const labels = partyChartData.map(d => getShortName(d.name));
          const data = partyChartData.map(d => d.value);
          const fullNames = partyChartData.map(d => d.name);

          new Chart(ctxParty, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: CHART_COLORS,
                borderWidth: 0,
                borderRadius: 4,
                barPercentage: 0.6
              }]
            },
            options: {
              indexAxis: 'y', // Horizontal
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(255, 255, 255, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#333',
                  borderColor: '#e2e8f0',
                  borderWidth: 1,
                  padding: 10,
                  callbacks: {
                    title: (ctx) => `${ctx[0].raw.toLocaleString()} उम्मेदवार`,
                    label: (ctx) => fullNames[ctx.dataIndex]
                  }
                }
              },
              scales: {
                x: {
                  grid: { color: '#f1f5f9', drawBorder: false },
                  ticks: { font: { size: 12 }, color: '#64748b' }
                },
                y: {
                  grid: { display: false },
                  ticks: { font: { size: 11, family: 'Noto Sans Devanagari' }, color: '#0f172a' }
                }
              }
            }
          });
        }

        // 2. Qualification Pie Chart (Doughnut style)
        const ctxQual = document.getElementById('qualificationChart');
        if (ctxQual && qualChartData.length > 0) {
          const labels = qualChartData.map(d => d.name);
          const data = qualChartData.map(d => d.value);

          new Chart(ctxQual, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: CHART_COLORS,
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              maintainAspectRatio: false,
              cutout: '60%', // Matches innerRadius: 50
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    pointStyle: 'circle',
                    usePointStyle: true,
                    boxWidth: 8,
                    font: { size: 11 }
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(255, 255, 255, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#333',
                  borderColor: '#e2e8f0',
                  borderWidth: 1,
                  padding: 10,
                  callbacks: {
                    label: (ctx) => {
                      const value = ctx.raw;
                      const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return ` ${value.toLocaleString()} (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
        }
      });
    </script>
  </body>
</html>