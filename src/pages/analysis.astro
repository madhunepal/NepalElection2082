---
export const prerender = false;
import { createClient } from '@supabase/supabase-js';
import '../styles/global.css';
import Header from '../components/Header.astro';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || process.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || process.env.PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  throw new Error('Missing PUBLIC_SUPABASE_URL or PUBLIC_SUPABASE_ANON_KEY in Vercel environment');
}

const supabase = createClient(supabaseUrl, supabaseKey);

// URL params
const url = new URL(Astro.request.url);
// Prepare Data for Charts (Party Distribution & Qualification)
async function fetchAllChartData() {
  let allData: any[] = [];
  let page = 0;
  const pageSize = 1000;
  while(true) {
    const { data } = await supabase
      .from('candidates')
      .select('party, qualification, province')
      .range(page * pageSize, (page + 1) * pageSize - 1);
      
    if (!data || data.length === 0) break;
    allData = allData.concat(data);
    if (data.length < pageSize) break;
    page++;
  }
  return allData;
}

const allCandidatesForCharts = await fetchAllChartData();

const partyCounts: Record<string, number> = {};
const qualificationCounts: Record<string, number> = {};
const provinceCounts: Record<string, number> = {};

if (allCandidatesForCharts) {
  allCandidatesForCharts.forEach(c => {
    if (c.party) {
      partyCounts[c.party] = (partyCounts[c.party] || 0) + 1;
    }
    
    if (c.province) {
      provinceCounts[c.province] = (provinceCounts[c.province] || 0) + 1;
    }

    let qual = c.qualification || 'Other';
    if (qual.includes('Class 10') || qual.includes('S.L.C.') || qual.includes('SEE')) qual = 'SLC / SEE';
    if (qual.includes('10+2') || qual.includes('Certificate') || qual.includes('Intermediate')) qual = '+2 / Diploma';
    if (qual.includes('Bachelor')) qual = 'Bachelors';
    if (qual.includes('Master')) qual = 'Masters';
    if (qual.includes('Ph.D') || qual.includes('M.Phil')) qual = 'Ph.D / M.Phil';
    if (qual.includes('Literate')) qual = 'Literate';
    if (qual.includes('Under S.L.C.')) qual = 'Below SLC';
    
    qualificationCounts[qual] = (qualificationCounts[qual] || 0) + 1;
  });
}

const partyChartData = Object.entries(partyCounts)
  .map(([name, value]) => ({ name, value }))
  .sort((a, b) => b.value - a.value)
  .slice(0, 10);

const qualChartData = Object.entries(qualificationCounts)
  .map(([name, value]) => ({ name, value }))
  .sort((a, b) => b.value - a.value);

const provinceChartData = Object.entries(provinceCounts)
  .map(([name, value]) => ({ name, value }))
  .sort((a, b) => b.value - a.value);
---

<html lang="ne">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>नेपाल निर्वाचन उम्मेदवार ड्यासबोर्ड | Nepal Election Dashboard</title>
    <!-- Chart.js Injection -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="bg-background min-h-screen font-sans antialiased text-foreground">
    
    <!-- Navigation Header -->
    <Header activeTab="analysis" />

    <main class="container mx-auto px-4 py-8">
      
      <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight mb-2 nepali-text text-foreground">
          विश्लेषण (Analysis)
        </h1>
        <p class="text-muted-foreground">
          तथ्याङ्क र चार्टहरू • Visualized Election Data Insights
        </p>
      </div>

      <!-- Analysis Charts Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8 mb-12">
        <!-- Party Chart -->
        <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
          <div class="mb-6">
            <h3 class="font-semibold text-foreground text-lg nepali-text">पार्टी अनुसार उम्मेदवार</h3>
            <p class="text-xs text-muted-foreground">Candidates by Party</p>
          </div>
          <div class="h-80 w-full relative">
            <canvas id="partyChart"></canvas>
          </div>
        </div>

        <!-- Province Chart -->
        <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
          <div class="mb-6">
            <h3 class="font-semibold text-foreground text-lg nepali-text">प्रदेश अनुसार उम्मेदवार</h3>
            <p class="text-xs text-muted-foreground">Candidates by Province</p>
          </div>
          <div class="h-80 w-full relative">
            <canvas id="provinceChart"></canvas>
          </div>
        </div>

        <!-- Qualification Chart -->
        <div class="bg-card border border-border rounded-xl p-6 shadow-sm lg:col-span-2 lg:w-1/2 lg:mx-auto w-full">
          <div class="mb-6">
            <h3 class="font-semibold text-foreground text-lg nepali-text">शैक्षिक योग्यता</h3>
            <p class="text-xs text-muted-foreground">Qualification Distribution</p>
          </div>
          <div class="h-80 w-full relative -ml-4 flex justify-center items-center">
             <canvas id="qualificationChart"></canvas>
          </div>
        </div>
      </div>
    </main>
    <script is:inline define:vars={{ partyChartData, qualChartData, provinceChartData }}>
      // -----------------------------
      // Chart.js Configuration
      // -----------------------------
      document.addEventListener("DOMContentLoaded", function() {
        const CHART_COLORS = [
          "hsl(215, 55%, 35%)", // Deep blue
          "hsl(350, 55%, 50%)", // Crimson
          "hsl(160, 50%, 45%)", // Green
          "hsl(35, 70%, 55%)",  // Orange/Yellow
          "hsl(270, 40%, 55%)", // Purple
          "hsl(190, 55%, 45%)", // Cyan
          "hsl(25, 65%, 50%)",  // Orange
          "hsl(200, 15%, 50%)", // Gray blue
        ];

        // 1. Party Bar Chart (Horizontal)
        const ctxParty = document.getElementById('partyChart');
        if (ctxParty && partyChartData.length > 0) {
          
          // Helper to abbreviate long party names exactly like their getShortPartyName()
          const getShortName = (name) => {
            const map = {
              "नेपाल कम्युनिष्ट पार्टी (एकीकृत मार्क्सवादी लेनिनवादी)": "नेकपा एमाले",
              "नेपाली काँग्रेस": "काँग्रेस",
              "नेपाल कम्युनिष्ट पार्टी (माओवादी केन्द्र)": "माओवादी केन्द्र",
              "राष्ट्रिय स्वतन्त्र पार्टी": "रास्वपा",
              "राष्ट्रिय प्रजातन्त्र पार्टी": "राप्रपा",
              "जनता समाजवादी पार्टी, नेपाल": "जसपा"
            };
            return map[name] || (name.length > 20 ? name.substring(0, 20) + '...' : name);
          };

          const labels = partyChartData.map(d => getShortName(d.name));
          const data = partyChartData.map(d => d.value);
          const fullNames = partyChartData.map(d => d.name);

          new Chart(ctxParty, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: CHART_COLORS,
                borderWidth: 0,
                borderRadius: 4,
                barPercentage: 0.6
              }]
            },
            options: {
              indexAxis: 'y', // Horizontal
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(255, 255, 255, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#333',
                  borderColor: '#e2e8f0',
                  borderWidth: 1,
                  padding: 10,
                  callbacks: {
                    title: (ctx) => `${ctx[0].raw.toLocaleString()} उम्मेदवार`,
                    label: (ctx) => fullNames[ctx.dataIndex]
                  }
                }
              },
              scales: {
                x: {
                  grid: { color: '#f1f5f9', drawBorder: false },
                  ticks: { font: { size: 12 }, color: '#64748b' }
                },
                y: {
                  grid: { display: false },
                  ticks: { font: { size: 11, family: 'Noto Sans Devanagari' }, color: '#0f172a' }
                }
              }
            }
          });
        }

        // 2. Qualification Pie Chart (Doughnut style)
        const ctxQual = document.getElementById('qualificationChart');
        if (ctxQual && qualChartData.length > 0) {
          const labels = qualChartData.map(d => d.name);
          const data = qualChartData.map(d => d.value);

          new Chart(ctxQual, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: CHART_COLORS,
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              maintainAspectRatio: false,
              cutout: '60%', // Matches innerRadius: 50
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    pointStyle: 'circle',
                    usePointStyle: true,
                    boxWidth: 8,
                    font: { size: 11 }
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(255, 255, 255, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#333',
                  borderColor: '#e2e8f0',
                  borderWidth: 1,
                  padding: 10,
                  callbacks: {
                    label: (ctx) => {
                      const value = ctx.raw;
                      const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return ` ${value.toLocaleString()} (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
        }
        // 3. Province Bar Chart (Horizontal)
        const ctxProvince = document.getElementById('provinceChart');
        if (ctxProvince && provinceChartData.length > 0) {
          const labels = provinceChartData.map(d => d.name);
          const data = provinceChartData.map(d => d.value);

          new Chart(ctxProvince, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: CHART_COLORS,
                borderWidth: 0,
                borderRadius: 4,
                barPercentage: 0.6
              }]
            },
            options: {
              indexAxis: 'y', // Horizontal
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(255, 255, 255, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#333',
                  borderColor: '#e2e8f0',
                  borderWidth: 1,
                  padding: 10,
                  callbacks: {
                    title: (ctx) => `${ctx[0].raw.toLocaleString()} उम्मेदवार`
                  }
                }
              },
              scales: {
                x: {
                  grid: { color: '#f1f5f9', drawBorder: false },
                  ticks: { font: { size: 12 }, color: '#64748b' }
                },
                y: {
                  grid: { display: false },
                  ticks: { font: { size: 11, family: 'Noto Sans Devanagari' }, color: '#0f172a' }
                }
              }
            }
          });
        }
      });
    </script>
  </body>
</html>